<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Cotizaci√≥n ‚Äì Jotaye Group LLC</title>
  <link rel="icon" href="favicon.ico" />
  <link rel="stylesheet" href="style.css" />
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <img src="logo-header.png" alt="Logo Jotaye" class="logo" />
      <h1>COTIZACI√ìN</h1>
    </header>

    <!-- Datos Empresa / Cliente -->
    <section class="info-empresa-cliente">
      <div class="empresa">
        <h3>Jotaye Group LLC</h3>
        <p>11201 SW 55Th St, Unit 286, Miramar FL 33025</p>
        <p>Tel: +1 305-417-2681</p>
        <p>Email: <a href="mailto:billing@jotayegroupllc.com">billing@jotayegroupllc.com</a></p>
        <p>Web: <a href="https://www.jotayegroupllc.com" target="_blank">jotayegroupllc.com</a></p>
      </div>
      <div class="cliente">
        <h3>Datos del Cliente</h3>
        <label>Nombre:   <input type="text" id="clienteNombre" /></label><br>
        <label>Tipo:     <input type="text" id="clienteTipo" /></label><br>
        <label>Direcci√≥n:<input type="text" id="clienteDireccion" /></label><br>
        <label>Email:    <input type="email" id="clienteEmail" /></label><br>
        <label>Tel√©fono: <input type="text" id="clienteTelefono" /></label>
      </div>
    </section>

    <!-- Encabezado superior -->
    <section class="encabezado-superior">
      <label>Fecha Emisi√≥n: <input type="date" id="fecha" /></label>
      <label>N¬∞ Cotizaci√≥n: <input type="text" id="numero" value="COT-20250613-0001" /></label>
      <label>Buscar N¬∞: <input type="text" id="inputNumeroBuscar" placeholder="COT-..." />
        <button id="btnBuscar" class="btn primary">Cargar</button>
      </label>
    </section>

    <!-- Tabla de √çtems -->
    <section class="tabla-items">
      <h2>Detalle de Productos / Servicios</h2>
      <table id="tablaItems">
        <thead>
          <tr>
            <th>ID</th><th>Descripci√≥n</th><th>Cantidad</th><th>Precio Unit.</th><th>Total</th><th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td><input class="descripcion" type="text" /></td>
            <td><input class="cantidad" type="number" min="1" value="1" /></td>
            <td><input class="precio"   type="number" min="0" step="0.01" value="0.00" /></td>
            <td class="total">$0.00</td>
            <td><button class="btnEliminar btn warning">Eliminar</button></td>
          </tr>
        </tbody>
      </table>
      <div class="acciones-filas">
        <button id="btnAgregarFila" class="btn success">+ Agregar Fila</button>
        <button id="btnEliminarFila" class="btn dark">‚àí Eliminar Fila</button>
      </div>
    </section>

    <!-- Informaci√≥n adicional -->
    <section class="concepto-observaciones">
      <h2>Informaci√≥n Adicional</h2>
      <label>Concepto:     <input type="text" id="inputConcepto" placeholder="Ej. Remodelaci√≥n de ba√±o" /></label><br>
      <label>Observaciones:<br>
        <textarea id="inputObservaciones" rows="3" placeholder="Condiciones, garant√≠as, etc."></textarea>
      </label>
    </section>

    <!-- Resumen de cotizaci√≥n -->
    <section class="resumen-factura">
      <h2>Resumen de Cotizaci√≥n</h2>
      <div>Subtotal: $<span id="resSubtotal">0.00</span></div>
      <div>Descuento (%): <input type="number" id="inputDescuento" min="0" max="100" value="0" /></div>
      <div>Monto Descuento: $<span id="resDescuento">0.00</span></div>
      <div>Impuestos (%): <input type="number" id="inputImpuesto" min="0" max="100" value="10" /></div>
      <div>Monto Impuesto: $<span id="resImpuestos">0.00</span></div>
      <div>Anticipo: <input type="number" id="inputAnticipo" min="0" step="0.01" value="0" /></div>
      <div class="total-neto">Total Neto: $<span id="resTotal">0.00</span></div>
    </section>

    <!-- Botones de acci√≥n -->
    <div class="acciones">
      <button id="btnGuardar"   class="btn success">üíæ Guardar</button>
      <button id="btnImprimir"  class="btn primary">üñ®Ô∏è Imprimir</button>
      <button id="btnFacturar"  class="btn warning">üìÑ Facturar</button>
      <button id="btnReiniciar" class="btn dark">üîÑ Reiniciar</button>
      <button id="btnEnviar"    class="btn success">‚úâÔ∏è Enviar</button>
      <!-- Borramos el bot√≥n Aprobar mientras solucionamos Stripe -->
    </div>
  </div>

  <script>
    // Inicializar Firebase
    var firebaseConfig = {
      apiKey: "AIzaSyBXBGILqL1JArsbJkUhX79veAnvkNcSg",
      authDomain: "presupuestos-1dd33.firebaseapp.com",
      projectId: "presupuestos-1dd33",
      storageBucket: "presupuestos-1dd33.appspot.com",
      messagingSenderId: "1077139821356",
      appId: "1:1077139821356:web:a831b1d90777b583b0d289"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();

    // Refs del DOM
    var tablaBody   = document.querySelector("#tablaItems tbody");
    var btnAgregar  = document.getElementById("btnAgregarFila");
    var btnEliminar = document.getElementById("btnEliminarFila");
    var btnGuardar  = document.getElementById("btnGuardar");
    var btnImprimir = document.getElementById("btnImprimir");
    var btnFacturar = document.getElementById("btnFacturar");
    var btnReiniciar= document.getElementById("btnReiniciar");
    var btnBuscar   = document.getElementById("btnBuscar");
    var btnEnviar   = document.getElementById("btnEnviar");
    var inpDesc     = document.getElementById("inputDescuento");
    var inpImp      = document.getElementById("inputImpuesto");
    var inpAnt      = document.getElementById("inputAnticipo");
    var resSub      = document.getElementById("resSubtotal");
    var resDesc     = document.getElementById("resDescuento");
    var resImp      = document.getElementById("resImpuestos");
    var resTot      = document.getElementById("resTotal");

    // Eventos
    btnAgregar .addEventListener("click", agregarFila);
    btnEliminar.addEventListener("click", eliminarFila);
    btnGuardar .addEventListener("click", guardarCotizacion);
    btnImprimir.addEventListener("click", ()=> window.print());
    btnFacturar.addEventListener("click", ()=> window.print());
    btnReiniciar.addEventListener("click", ()=> location.reload());
    btnBuscar  .addEventListener("click", buscar);
    btnEnviar  .addEventListener("click", enviarEmail);
    [inpDesc, inpImp, inpAnt].forEach(i=> i.addEventListener("input", recalcularTotales));

    // Funciones de filas y totales
    function agregarFila() {
      var row = document.createElement("tr");
      row.innerHTML = ""
        + "<td>"+(tablaBody.rows.length+1)+"</td>"
        + "<td><input class='descripcion' type='text'></td>"
        + "<td><input class='cantidad' type='number' min='1' value='1'></td>"
        + "<td><input class='precio'   type='number' min='0' step='0.01' value='0.00'></td>"
        + "<td class='total'>$0.00</td>"
        + "<td><button class='btnEliminar btn warning'>Eliminar</button></td>";
      tablaBody.appendChild(row);
      row.querySelector(".cantidad").addEventListener("input", recalcularTotales);
      row.querySelector(".precio") .addEventListener("input", recalcularTotales);
      row.querySelector(".btnEliminar").addEventListener("click", function(){
        row.remove(); recalcularTotales();
      });
      recalcularTotales();
    }
    function eliminarFila(){
      if(tablaBody.rows.length>0){ tablaBody.deleteRow(-1); recalcularTotales(); }
    }
    function recalcularTotales(){
      var sub=0;
      tablaBody.querySelectorAll("tr").forEach(r=>{
        var c=parseFloat(r.querySelector(".cantidad").value)||0;
        var p=parseFloat(r.querySelector(".precio") .value)||0;
        var t=c*p; r.querySelector(".total").innerText="$"+t.toFixed(2);
        sub+=t;
      });
      var d=sub*(parseFloat(inpDesc.value)||0)/100;
      var i=(sub-d)*(parseFloat(inpImp.value)||0)/100;
      var a=parseFloat(inpAnt.value)||0;
      resSub.innerText = sub.toFixed(2);
      resDesc.innerText= d.toFixed(2);
      resImp.innerText = i.toFixed(2);
      resTot.innerText = (sub-d+i-a).toFixed(2);
    }

    // Firestore: guardar / buscar
    function leerFormulario(){
      return {
        fecha:document.getElementById("fecha").value,
        numero:document.getElementById("numero").value,
        clienteNombre:document.getElementById("clienteNombre").value,
        clienteTipo:document.getElementById("clienteTipo").value,
        clienteDireccion:document.getElementById("clienteDireccion").value,
        clienteEmail:document.getElementById("clienteEmail").value,
        clienteTelefono:document.getElementById("clienteTelefono").value,
        items:Array.from(tablaBody.querySelectorAll("tr")).map((r,i)=>({
          id:i+1,
          descripcion:r.querySelector(".descripcion").value,
          cantidad:+r.querySelector(".cantidad").value,
          precio:+r.querySelector(".precio").value,
          total:parseFloat(r.querySelector(".total").innerText.replace("$",""))
        })),
        concepto:document.getElementById("inputConcepto").value,
        observaciones:document.getElementById("inputObservaciones").value,
        subtotal:parseFloat(resSub.innerText),
        descuento:parseFloat(resDesc.innerText),
        impuestos:parseFloat(resImp.innerText),
        anticipo:parseFloat(inpAnt.value),
        total:parseFloat(resTot.innerText)
      };
    }
    async function guardarCotizacion(){
      var d=leerFormulario();
      await db.collection("cotizaciones").add(d);
      alert("Cotizaci√≥n guardada");
    }
    async function buscar(){
      var n=document.getElementById("inputNumeroBuscar").value.trim();
      if(!n) return alert("Escribe n√∫mero");
      var snap=await db.collection("cotizaciones")
        .where("numero","==",n).get();
      if(snap.empty) return alert("No encontrado");
      var data=snap.docs[0].data();
      // llenar
      document.getElementById("fecha").value = data.fecha;
      document.getElementById("numero").value= data.numero;
      document.getElementById("clienteNombre").value=data.clienteNombre;
      document.getElementById("clienteTipo").value=data.clienteTipo;
      document.getElementById("clienteDireccion").value=data.clienteDireccion;
      document.getElementById("clienteEmail").value=data.clienteEmail;
      document.getElementById("clienteTelefono").value=data.clienteTelefono;
      tablaBody.innerHTML="";
      data.items.forEach(it=>{
        agregarFila();
        var r=tablaBody.lastElementChild;
        r.querySelector(".descripcion").value=it.descripcion;
        r.querySelector(".cantidad") .value=it.cantidad;
        r.querySelector(".precio")   .value=it.precio;
      });
      document.getElementById("inputConcepto").value=data.concepto;
      document.getElementById("inputObservaciones").value=data.observaciones;
      recalcularTotales();
    }

    // Enviar por email
    async function enviarEmail(){
      var d=leerFormulario();
      try{
        var res=await fetch("https://mail-server-byrb.onrender.com/send-quotation",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify(d)
        });
        if(!res.ok) throw new Error(res.status);
        alert("Correo enviado");
      }catch(e){
        console.error(e);
        alert("Error enviando correo");
      }
    }

    // Inicial
    recalcularTotales();
  </script>
</body>
</html>
