<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Cotización – Jotaye Group LLC</title>
  <link rel="icon" href="favicon.ico" />
  <link rel="stylesheet" href="style.css" />
  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <div class="container" id="app">
    <!-- Aquí va toda tu interfaz original -->
    <!-- … header, cliente, tabla de ítems, totales, botones … -->
  </div>

  <script>
    // — Firebase v8 —
    const firebaseConfig = {
      apiKey: "AIzaSyBXBGILqL1JArsbJkUhX79veAnvkNcSg",
      authDomain: "presupuestos-1dd33.firebaseapp.com",
      projectId: "presupuestos-1dd33",
      storageBucket: "presupuestos-1dd33.appspot.com",
      messagingSenderId: "1077139821356",
      appId: "1:1077139821356:web:a831b1d90777b583b0d289"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // — Stripe —
    const stripe = Stripe("pk_test_51RYYSpPFkZDbc1hwxDRXWJQ2T4sYQEtA5Ejx2gB2sCA90tdUQwJiqxdzkkn2VRz3mdFVu5BxbBnZheXQcNSB1CxT00hWKt2xXI");

    // — Capturar params de URL para checkout —
    const params = new URLSearchParams(location.search);
    if (params.get("action")==="checkout" && params.get("numero")) {
      // Cargo la cotización y abro checkout
      buscarCotizacion(params.get("numero"))
        .then(data => iniciarCheckout(data))
        .catch(()=> alert("No existe esa cotización."));
      // no inicializo el resto de la UI
      return;
    }

    // — Inyectar tu HTML original en #app —
    document.getElementById("app").innerHTML = `
      <!-- Pega aquí EXACTAMENTE tu HTML tal cual ya lo tenías, con todos los IDs -->
      <!-- Header, formularios de cliente, tabla, totales y botones: Guardar, Imprimir, Facturar, Reiniciar, Enviar, Aprobar -->
    `;

    // — Referencias al DOM —
    const tablaBody   = document.querySelector("#tablaItems tbody");
    const btnAgregar  = document.getElementById("btnAgregarFila");
    const btnEliminar = document.getElementById("btnEliminarFila");
    const btnGuardar  = document.getElementById("btnGuardar");
    const btnImprimir = document.getElementById("btnImprimir");
    const btnFacturar = document.getElementById("btnFacturar");
    const btnReiniciar= document.getElementById("btnReiniciar");
    const btnBuscar   = document.getElementById("btnBuscar");
    const btnEnviar   = document.getElementById("btnEnviar");
    const btnAprobar  = document.getElementById("btnAprobar");
    const inpDesc     = document.getElementById("inputDescuento");
    const inpImp      = document.getElementById("inputImpuesto");
    const inpAnt      = document.getElementById("inputAnticipo");
    const resSub      = document.getElementById("resSubtotal");
    const resDesc     = document.getElementById("resDescuento");
    const resImp      = document.getElementById("resImpuestos");
    const resTot      = document.getElementById("resTotal");

    // — Eventos básicos —
    btnAgregar .addEventListener("click", agregarFila);
    btnEliminar.addEventListener("click", eliminarFila);
    btnGuardar .addEventListener("click", guardarCotizacion);
    btnImprimir.addEventListener("click", ()=>window.print());
    btnFacturar.addEventListener("click", ()=>window.print());
    btnReiniciar.addEventListener("click", ()=>location.reload());
    btnBuscar  .addEventListener("click", ()=>buscar().catch(e=>alert(e.message)));
    btnEnviar  .addEventListener("click", enviarEmail);
    btnAprobar .addEventListener("click", ()=>{ 
      const data = leerFormulario();
      iniciarCheckout(data);
    });
    [inpDesc, inpImp, inpAnt].forEach(i=>i.addEventListener("input", recalcularTotales));

    // — Funciones de fila y totales (igual que antes) —
    function agregarFila(){ /* … */ }
    function eliminarFila(){ /* … */ }
    function recalcularTotales(){ /* … */ }
    function leerFormulario(){ /* … */ }

    // — Firestore: guardar / buscar —
    async function guardarCotizacion(){
      const d = leerFormulario();
      await db.collection("cotizaciones").add(d);
      alert("Cotización guardada");
    }
    async function buscarCotizacion(num){
      const snap = await db.collection("cotizaciones")
        .where("numero","==",num).get();
      if(snap.empty) throw new Error("No encontrado");
      return snap.docs[0].data();
    }
    async function buscar(){
      const num = document.getElementById("inputNumeroBuscar").value.trim();
      const d = await buscarCotizacion(num);
      llenarFormulario(d);
    }
    function llenarFormulario(d){ /* … */ }

    // — Enviar email —
    async function enviarEmail(){
      const d = leerFormulario();
      try{
        const res = await fetch("https://mail-server-byrb.onrender.com/send-quotation", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify(d)
        });
        if(!res.ok) throw new Error(res.status);
        alert("Correo enviado");
      }catch(e){
        console.error(e);
        alert("Error enviando correo");
      }
    }

    // — Iniciar Stripe Checkout —
    async function iniciarCheckout(data){
      if(!data.anticipo || data.anticipo<=0){
        return alert("No hay anticipo pendiente");
      }
      try {
        const res = await fetch("https://mail-server-byrb.onrender.com/create-checkout-session", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({
            anticipo: data.anticipo,
            numero: data.numero
          })
        });
        const { url, error } = await res.json();
        if (error) throw new Error(error);
        window.location = url;
      } catch(err) {
        console.error(err);
        alert("No se pudo iniciar Checkout: "+err.message);
      }
    }

    // — Arrancar —
    recalcularTotales();
  </script>
</body>
</html>
