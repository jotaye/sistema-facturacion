<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sistema de Cotización – Jotaye Group LLC</title>
  <link rel="icon" href="favicon.ico">
  <link rel="stylesheet" href="style.css">
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <div class="container" id="app">
    <!-- El contenido original de tu interfaz irá aquí -->
    <!-- ... header, formularios, tabla, botones ... -->
  </div>

  <script>
    // --- Firebase v8 Init ---
    const firebaseConfig = {
      apiKey: "AIzaSyBXBGILqL1JArsbJkUhX79veAnvkNcSg",
      authDomain: "presupuestos-1dd33.firebaseapp.com",
      projectId: "presupuestos-1dd33",
      storageBucket: "presupuestos-1dd33.appspot.com",
      messagingSenderId: "1077139821356",
      appId: "1:1077139821356:web:a831b1d90777b583b0d289"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- Stripe Init ---
    const stripe = Stripe("pk_test_51RYYSpPFkZDbc1hwxDRXWJQ2T4sYQEtA5Ejx2gB2sCA90tdUQwJiqxdzkkn2VRz3mdFVu5BxbBnZheXQcNSB1CxT00hWKt2xXI");

    // --- Capturar parámetros de URL para approve desde correo ---
    const params = new URLSearchParams(location.search);
    if (params.get("action")==="approve" && params.get("numero")) {
      buscarCotizacion(params.get("numero"))
        .then(data => mostrarStripePayment(data))
        .catch(() => alert("Cotización no encontrada"));
      // No inicializar el flujo normal
      return;
    }

    // --- Aquí cargas tu HTML estático original dentro de #app ---
    document.getElementById("app").innerHTML = `
      <header>…</header>
      <!-- Toda tu interfaz completa (idéntica a la que ya funciona) -->
    `;

    // --- Referencias DOM (tras inyectar el HTML) ---
    const tablaBody    = document.querySelector("#tablaItems tbody");
    const btnAgregar   = document.getElementById("btnAgregarFila");
    const btnEliminar  = document.getElementById("btnEliminarFila");
    const btnGuardar   = document.getElementById("btnGuardar");
    const btnImprimir  = document.getElementById("btnImprimir");
    const btnFacturar  = document.getElementById("btnFacturar");
    const btnReiniciar = document.getElementById("btnReiniciar");
    const btnBuscar    = document.getElementById("btnBuscar");
    const btnEnviar    = document.getElementById("btnEnviar");
    const btnAprobar   = document.getElementById("btnAprobar");
    const inpDesc      = document.getElementById("inputDescuento");
    const inpImp       = document.getElementById("inputImpuesto");
    const inpAnt       = document.getElementById("inputAnticipo");
    const resSub       = document.getElementById("resSubtotal");
    const resDesc      = document.getElementById("resDescuento");
    const resImp       = document.getElementById("resImpuestos");
    const resTot       = document.getElementById("resTotal");

    // --- Eventos ---
    btnAgregar.addEventListener("click", agregarFila);
    btnEliminar.addEventListener("click", eliminarFila);
    btnGuardar.addEventListener("click", guardarCotizacion);
    btnImprimir.addEventListener("click", () => window.print());
    btnFacturar.addEventListener("click", () => window.print());
    btnReiniciar.addEventListener("click", () => location.reload());
    btnBuscar.addEventListener("click", () => buscar().catch(e => alert(e.message)));
    btnEnviar.addEventListener("click", enviarEmail);
    btnAprobar.addEventListener("click", aprobarYpagar);
    [inpDesc, inpImp, inpAnt].forEach(i => i.addEventListener("input", recalcularTotales));

    // --- Funciones de tabla y totales ---
    function agregarFila() {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${tablaBody.rows.length+1}</td>
        <td><input class="descripcion" type="text"></td>
        <td><input class="cantidad" type="number" min="1" value="1"></td>
        <td><input class="precio" type="number" min="0" step="0.01" value="0.00"></td>
        <td class="total">$0.00</td>
        <td><button class="btnEliminar btn warning">Eliminar</button></td>
      `;
      tablaBody.appendChild(row);
      row.querySelector(".cantidad").addEventListener("input", recalcularTotales);
      row.querySelector(".precio").addEventListener("input", recalcularTotales);
      row.querySelector(".btnEliminar").addEventListener("click", () => {
        row.remove(); recalcularTotales();
      });
      recalcularTotales();
    }

    function eliminarFila() {
      if (tablaBody.rows.length>0) {
        tablaBody.deleteRow(-1);
        recalcularTotales();
      }
    }

    function recalcularTotales() {
      let sub=0;
      tablaBody.querySelectorAll("tr").forEach(r => {
        const c = parseFloat(r.querySelector(".cantidad").value)||0;
        const p = parseFloat(r.querySelector(".precio").value)||0;
        const t = c*p;
        r.querySelector(".total").innerText = "$"+t.toFixed(2);
        sub += t;
      });
      const d = sub*(parseFloat(inpDesc.value)||0)/100;
      const i = (sub-d)*(parseFloat(inpImp.value)||0)/100;
      const a = parseFloat(inpAnt.value)||0;
      const neto = sub - d + i - a;
      resSub.innerText = sub.toFixed(2);
      resDesc.innerText = d.toFixed(2);
      resImp.innerText = i.toFixed(2);
      resTot.innerText = neto.toFixed(2);
    }

    function leerFormulario() {
      return {
        fecha: document.getElementById("fecha").value,
        numero: document.getElementById("numero").value,
        clienteNombre: document.getElementById("clienteNombre").value,
        clienteTipo: document.getElementById("clienteTipo").value,
        clienteDireccion: document.getElementById("clienteDireccion").value,
        clienteEmail: document.getElementById("clienteEmail").value,
        clienteTelefono: document.getElementById("clienteTelefono").value,
        items: Array.from(tablaBody.querySelectorAll("tr")).map((r,i)=>({
          id: i+1,
          descripcion: r.querySelector(".descripcion").value,
          cantidad: +r.querySelector(".cantidad").value,
          precio: +r.querySelector(".precio").value,
          total: parseFloat(r.querySelector(".total").innerText.replace("$",""))
        })),
        concepto: document.getElementById("inputConcepto").value,
        observaciones: document.getElementById("inputObservaciones").value,
        subtotal: parseFloat(resSub.innerText),
        descuento: parseFloat(resDesc.innerText),
        impuestos: parseFloat(resImp.innerText),
        anticipo: parseFloat(inpAnt.value),
        total: parseFloat(resTot.innerText)
      };
    }

    async function guardarCotizacion() {
      const data = leerFormulario();
      await db.collection("cotizaciones").add(data);
      alert("Cotización guardada.");
    }

    async function buscarCotizacion(num) {
      const snap = await db.collection("cotizaciones").where("numero","==",num).get();
      if (snap.empty) throw new Error("No encontrado");
      return snap.docs[0].data();
    }

    async function buscar() {
      const num = document.getElementById("inputNumeroBuscar").value.trim();
      const data = await buscarCotizacion(num);
      llenarFormulario(data);
    }

    function llenarFormulario(d) {
      document.getElementById("fecha").value = d.fecha;
      document.getElementById("numero").value = d.numero;
      document.getElementById("clienteNombre").value = d.clienteNombre;
      document.getElementById("clienteTipo").value = d.clienteTipo;
      document.getElementById("clienteDireccion").value = d.clienteDireccion;
      document.getElementById("clienteEmail").value = d.clienteEmail;
      document.getElementById("clienteTelefono").value = d.clienteTelefono;
      tablaBody.innerHTML = "";
      d.items.forEach(it=>{
        agregarFila();
        const row = tablaBody.lastElementChild;
        row.querySelector(".descripcion").value = it.descripcion;
        row.querySelector(".cantidad").value = it.cantidad;
        row.querySelector(".precio").value = it.precio;
      });
      recalcularTotales();
      document.getElementById("inputConcepto").value = d.concepto;
      document.getElementById("inputObservaciones").value = d.observaciones;
    }

    async function enviarEmail() {
      const data = leerFormulario();
      try {
        const res = await fetch("https://mail-server-byrb.onrender.com/send-quotation", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error("HTTP "+res.status);
        alert("Correo enviado.");
      } catch (e) {
        console.error(e);
        alert("Error enviando correo.");
      }
    }

    async function aprobarYpagar() {
      const data = leerFormulario();
      await db.collection("facturas").doc(data.numero).set(data);
      mostrarStripePayment(data);
    }

    function mostrarStripePayment(d) {
      const app = document.getElementById("app");
      if (d.anticipo <= 0) {
        app.innerHTML = `
          <h2>No hay anticipo pendiente</h2>
          <button onclick="location.reload()" class="btn primary">Volver</button>
        `;
        return;
      }
      app.innerHTML = `
        <h2>Pagar Anticipo: $${d.anticipo.toFixed(2)}</h2>
        <div id="card-element"></div>
        <button id="btnPagar" class="btn primary">Pagar</button>
      `;
      fetch("https://mail-server-byrb.onrender.com/create-payment-intent", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ amount: d.anticipo })
      })
      .then(r=>r.json())
      .then(json=>{
        const elements = stripe.elements();
        const card = elements.create("card");
        card.mount("#card-element");
        document.getElementById("btnPagar").addEventListener("click", ()=>{
          stripe.confirmCardPayment(json.clientSecret, { payment_method:{ card }})
            .then(result=>{
              if (result.error) alert(result.error.message);
              else alert("Pago exitoso. Gracias.");
            });
        });
      })
      .catch(e=>{
        console.error(e);
        alert("Error iniciando pago: "+(e.error||e.message));
      });
    }

    // Al cargar
    recalcularTotales();
  </script>
</body>
</html>
