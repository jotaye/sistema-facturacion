<!-- index.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Cotizaci√≥n ‚Äì Jotaye Group LLC</title>
  <link rel="icon" href="favicon.ico"/>
  <link rel="stylesheet" href="style.css"/>
  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <div class="container" id="app">
    <header>
      <img src="logo-header.png" alt="Logo Jotaye" class="logo"/>
      <h1>COTIZACI√ìN</h1>
    </header>
    <section class="info-empresa-cliente">
      <div class="empresa">
        <h3>Jotaye Group LLC</h3>
        <p>11201 SW 55Th St, Unit 286, Miramar FL 33025</p>
        <p>Tel: +1 305-417-2681</p>
        <p>Email: <a href="mailto:sales@jotayegroupllc.com">sales@jotayegroupllc.com</a></p>
        <p>Web: <a href="https://www.jotayegroupllc.com" target="_blank">jotayegroupllc.com</a></p>
      </div>
      <div class="cliente">
        <h3>Datos del Cliente</h3>
        <label>Nombre:     <input type="text" id="clienteNombre"/></label><br/>
        <label>Tipo:       <input type="text" id="clienteTipo"/></label><br/>
        <label>Direcci√≥n:  <input type="text" id="clienteDireccion"/></label><br/>
        <label>Email:      <input type="email" id="clienteEmail"/></label><br/>
        <label>Tel√©fono:   <input type="text" id="clienteTelefono"/></label>
      </div>
    </section>
    <section class="encabezado-superior">
      <label>Fecha Emisi√≥n: <input type="date" id="fecha"/></label>
      <label>N¬∞ Cotizaci√≥n: <input type="text" id="numero" value="COT-YYYYMMDD-0001"/></label>
      <label>Buscar N¬∞:
        <input type="text" id="inputNumeroBuscar" placeholder="COT-..."/>
        <button id="btnBuscar" class="btn primary">Cargar</button>
      </label>
    </section>
    <section class="tabla-items">
      <h2>Detalle de Productos / Servicios</h2>
      <table id="tablaItems">
        <thead>
          <tr>
            <th>ID</th><th>Descripci√≥n</th><th>Cantidad</th>
            <th>Precio Unit.</th><th>Total</th><th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td><input class="descripcion" type="text"/></td>
            <td><input class="cantidad" type="number" min="1" value="1"/></td>
            <td><input class="precio"   type="number" min="0" step="0.01" value="0.00"/></td>
            <td class="total">$0.00</td>
            <td><button class="btnEliminar btn warning">Eliminar</button></td>
          </tr>
        </tbody>
      </table>
      <div class="acciones-filas">
        <button id="btnAgregarFila" class="btn success">+ Agregar Fila</button>
        <button id="btnEliminarFila" class="btn dark">‚àí Eliminar Fila</button>
      </div>
    </section>
    <section class="concepto-observaciones">
      <h2>Informaci√≥n Adicional</h2>
      <label>Concepto:     <input type="text" id="inputConcepto" placeholder="Ej. Remodelaci√≥n"/></label><br/>
      <label>Observaciones:<br/>
        <textarea id="inputObservaciones" rows="3" placeholder="Condiciones, garant√≠as, etc."></textarea>
      </label>
    </section>
    <section class="resumen-factura">
      <h2>Resumen de Cotizaci√≥n</h2>
      <div>Subtotal: $<span id="resSubtotal">0.00</span></div>
      <div>Descuento (%): <input type="number" id="inputDescuento" min="0" max="100" value="0"/></div>
      <div>Monto Descuento: $<span id="resDescuento">0.00</span></div>
      <div>Impuestos (%): <input type="number" id="inputImpuesto" min="0" max="100" value="10"/></div>
      <div>Monto Impuesto: $<span id="resImpuestos">0.00</span></div>
      <div>Anticipo: <input type="number" id="inputAnticipo" min="0" step="0.01" value="0"/></div>
      <div class="total-neto">Total Neto: $<span id="resTotal">0.00</span></div>
    </section>
    <div class="acciones">
      <button id="btnGuardar"   class="btn success">üíæ Guardar</button>
      <button id="btnImprimir"  class="btn primary">üñ®Ô∏è Imprimir</button>
      <button id="btnFacturar"  class="btn warning">üìÑ Facturar</button>
      <button id="btnReiniciar" class="btn dark">üîÑ Reiniciar</button>
      <button id="btnEnviar"    class="btn success">‚úâÔ∏è Enviar</button>
      <button id="btnAprobar"   class="btn primary">‚úÖ Aprobar (Pagar)</button>
    </div>
  </div>

  <script>
  (async function(){
    // ‚Äî Firebase v8 Init ‚Äî
    const firebaseConfig = {
      apiKey:    "TU_FIREBASE_API_KEY",
      authDomain:"TU_FIREBASE_AUTHDOMAIN",
      projectId: "TU_FIREBASE_PROJECT_ID",
      storageBucket:"TU_FIREBASE_STORAGE_BUCKET",
      messagingSenderId:"TU_FIREBASE_MESSAGING_SENDER_ID",
      appId:     "TU_FIREBASE_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ‚Äî Stripe Init ‚Äî
    const stripe = Stripe("TU_STRIPE_PUBLISHABLE_KEY");

    // ‚Äî DOM Refs ‚Äî
    const tablaBody    = document.querySelector("#tablaItems tbody");
    const btnAgregar   = document.getElementById("btnAgregarFila");
    const btnEliminar  = document.getElementById("btnEliminarFila");
    const btnGuardar   = document.getElementById("btnGuardar");
    const btnImprimir  = document.getElementById("btnImprimir");
    const btnFacturar  = document.getElementById("btnFacturar");
    const btnReiniciar = document.getElementById("btnReiniciar");
    const btnBuscar    = document.getElementById("btnBuscar");
    const btnEnviar    = document.getElementById("btnEnviar");
    const btnAprobar   = document.getElementById("btnAprobar");
    const inpDesc      = document.getElementById("inputDescuento");
    const inpImp       = document.getElementById("inputImpuesto");
    const inpAnt       = document.getElementById("inputAnticipo");
    const resSub       = document.getElementById("resSubtotal");
    const resDesc      = document.getElementById("resDescuento");
    const resImp       = document.getElementById("resImpuestos");
    const resTot       = document.getElementById("resTotal");

    // ‚Äî Listeners B√°sicos ‚Äî
    btnAgregar .addEventListener("click", agregarFila);
    btnEliminar.addEventListener("click", eliminarFila);
    btnGuardar .addEventListener("click", guardarCotizacion);
    btnImprimir.addEventListener("click", ()=>window.print());
    btnFacturar.addEventListener("click", ()=>window.print());
    btnReiniciar.addEventListener("click", ()=>location.reload());
    btnBuscar.addEventListener("click", ()=>buscar().catch(e=>alert(e.message)));
    btnEnviar .addEventListener("click", enviarEmail);
    btnAprobar.addEventListener("click", ()=>iniciarCheckout());
    [inpDesc, inpImp, inpAnt].forEach(i=>i.addEventListener("input", recalcularTotales));

    // ‚Äî URL params: carga/checkout/success ‚Äî
    const params = new URLSearchParams(location.search);
    const numero = params.get("numero");
    if (params.get("action")==="checkout" && numero) {
      await buscarCotizacion(numero);
      return iniciarCheckout();
    }
    if (params.get("success")==="true" && numero) {
      const data = await buscarCotizacion(numero);
      // Guardar factura
      await db.collection("facturas").doc(numero).set(data);
      llenarFormulario(data, true);
      return;
    }

    // arranca
    recalcularTotales();

    // ‚Äî FUNCIONES ‚Äî
    function agregarFila(){
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${tablaBody.rows.length+1}</td>
        <td><input class="descripcion" type="text"></td>
        <td><input class="cantidad"   type="number" min="1" value="1"></td>
        <td><input class="precio"      type="number" min="0" step="0.01" value="0.00"></td>
        <td class="total">$0.00</td>
        <td><button class="btnEliminar btn warning">Eliminar</button></td>`;
      tablaBody.appendChild(row);
      row.querySelector(".cantidad").addEventListener("input", recalcularTotales);
      row.querySelector(".precio") .addEventListener("input", recalcularTotales);
      row.querySelector(".btnEliminar")
         .addEventListener("click", ()=>{ row.remove(); recalcularTotales(); });
      recalcularTotales();
    }
    function eliminarFila(){
      if(tablaBody.rows.length>0){
        tablaBody.deleteRow(-1);
        recalcularTotales();
      }
    }
    function recalcularTotales(){
      let sub=0;
      tablaBody.querySelectorAll("tr").forEach(r=>{
        const c=+r.querySelector(".cantidad").value||0;
        const p=+r.querySelector(".precio").value||0;
        const t=c*p; r.querySelector(".total").innerText=`$${t.toFixed(2)}`; sub+=t;
      });
      const dPct=+inpDesc.value||0, dAmt=sub*dPct/100;
      const iPct=+inpImp.value||0, iAmt=(sub-dAmt)*iPct/100;
      const antic=parseFloat(inpAnt.value)||0;
      resSub.innerText=sub.toFixed(2);
      resDesc.innerText=dAmt.toFixed(2);
      resImp.innerText=iAmt.toFixed(2);
      resTot.innerText=(sub-dAmt+iAmt-antic).toFixed(2);
    }
    function leerFormulario(){
      return {
        fecha: document.getElementById("fecha").value,
        numero: document.getElementById("numero").value,
        clienteNombre: document.getElementById("clienteNombre").value,
        clienteTipo: document.getElementById("clienteTipo").value,
        clienteDireccion: document.getElementById("clienteDireccion").value,
        clienteEmail: document.getElementById("clienteEmail").value,
        clienteTelefono: document.getElementById("clienteTelefono").value,
        items: Array.from(tablaBody.querySelectorAll("tr")).map((r,i)=>({
          id:i+1,
          descripcion:r.querySelector(".descripcion").value,
          cantidad:+r.querySelector(".cantidad").value,
          precio:+r.querySelector(".precio").value,
          total: parseFloat(r.querySelector(".total").innerText.replace("$",""))
        })),
        concepto:document.getElementById("inputConcepto").value,
        observaciones:document.getElementById("inputObservaciones").value,
        subtotal: parseFloat(resSub.innerText),
        descuento:parseFloat(resDesc.innerText),
        impuestos:parseFloat(resImp.innerText),
        anticipo:parseFloat(inpAnt.value),
        total:parseFloat(resTot.innerText)
      };
    }
    async function guardarCotizacion(){
      const d=leerFormulario();
      await db.collection("cotizaciones").add(d);
      alert("Cotizaci√≥n guardada");
    }
    async function buscarCotizacion(num){
      const snap=await db.collection("cotizaciones")
                       .where("numero","==",num).get();
      if(snap.empty) throw new Error("No encontrado");
      const data=snap.docs[0].data();
      llenarFormulario(data,false);
      return data;
    }
    async function buscar(){
      const num=document.getElementById("inputNumeroBuscar").value.trim();
      if(!num) return alert("Escribe un n√∫mero");
      await buscarCotizacion(num);
    }
    function llenarFormulario(d,isInvoice){
      // llena campos
      document.getElementById("fecha").value    = d.fecha;
      document.getElementById("numero").value   = d.numero;
      ["clienteNombre","clienteTipo",
       "clienteDireccion","clienteEmail",
       "clienteTelefono"].forEach(id=>{
        document.getElementById(id).value = d[id];
      });
      tablaBody.innerHTML="";
      d.items.forEach(it=>{
        agregarFila();
        const r=tablaBody.lastElementChild;
        r.querySelector(".descripcion").value=it.descripcion;
        r.querySelector(".cantidad").value   =it.cantidad;
        r.querySelector(".precio").value     =it.precio;
      });
      document.getElementById("inputConcepto").value      = d.concepto;
      document.getElementById("inputObservaciones").value = d.observaciones;
      recalcularTotales();
      // si es factura, s√≥lo imprimir
      if(isInvoice){
        ["btnGuardar","btnEnviar","btnFacturar","btnBuscar","btnAprobar"]
          .forEach(id=>document.getElementById(id).style.display="none");
        btnImprimir.innerText="üñ®Ô∏è Imprimir Factura";
      }
    }
    async function enviarEmail(){
      try {
        const d=leerFormulario();
        const res=await fetch(
          "https://mail-server-byrb.onrender.com/send-quotation",
          {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)}
        );
        if(!res.ok) throw new Error(res.status);
        alert("Cotizaci√≥n enviada");
      } catch(e){
        console.error(e);
        alert("Error enviando cotizaci√≥n");
      }
    }
    async function iniciarCheckout(){
      const d=leerFormulario();
      const minAnt = d.total>=2500
        ? Math.round(d.total*0.3*100)/100
        : d.total;
      if(d.anticipo < minAnt){
        return alert(
          d.total>=2500
            ? `El anticipo m√≠nimo es $${minAnt.toFixed(2)}`
            : `Debe pagar el total de $${d.total.toFixed(2)}`
        );
      }
      try {
        const res=await fetch(
          "https://mail-server-byrb.onrender.com/create-checkout-session",
          {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
              numero:d.numero,
              anticipo:d.anticipo,
              clienteEmail:d.clienteEmail
            })
          }
        );
        const {url,error}=await res.json();
        if(error) throw new Error(error);
        window.location=url;
      } catch(err){
        console.error(err);
        alert("No se pudo iniciar Stripe Checkout:\n"+err.message);
      }
    }
  })();
  </script>
</body>
</html>
